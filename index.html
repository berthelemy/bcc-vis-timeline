<!DOCTYPE HTML>
<html>
<head>
  <title>Timeline basic demo</title>

  <!-- Load jquery for ajax support -->
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="node_modules/tabletop/src/tabletop.js"></script>
  <script src="node_modules/vis/dist/vis.js"></script>
  
  <link href="node_modules/vis/dist/vis.css" rel="stylesheet" type="text/css" />

  <style type="text/css">
    body, html {
      font-family: sans-serif;
    }
  </style>
</head>
<body>

<h1>BCC Draft Timeline 2015/16</h1>

<p>CS = children in small groups | CF = children in families | CL = children in large group</p>

<div id="visualization"></div> <!-- Where the timeline will appear -->

<script>
 
 // ID of the Google Spreadsheet

 // Make sure it is public or set to Anyone with link can view 
 
var public_spreadsheet_url = 'https://docs.google.com/spreadsheets/d/15TidIQ9YgnEinL3YAJwX8HEoVHM4xPTiLpnC_XtFi5c/pubhtml';

 
// When the page is loaded then run this function
 $(document).ready( function() {

// Initialise tabletop (which reads the Google spreadsheet into a model)
        Tabletop.init( { key: public_spreadsheet_url,
                         callback: processData, // the function to run next
                         wanted: [ "od1", "Groups" ], // the sheets to read
                         debug: true } )
      })
        

// Once tabletop is initialised, run this function
function processData(data, tabletop) {

  // Process main data table
  var mainData = tabletop.sheets("od1").all(); // Read data lines from od1 sheet

  var items = new vis.DataSet(); // initialise a new vis Dataset

  for (var g = 0; g < mainData.length; g++) { // Run through all the data lines
    start = dateFormat(mainData[g].startdate,"start"); // Reformat the start dates to work with vis
     
    if (mainData[g].enddate) { // If an enddate exists, then reformat this too
      end = dateFormat(mainData[g].enddate,"end"); 
      type = 'range'; // Items with an end date will be displayed as a range
      } else {
        end = '';
        type = 'point'
      }

    if (mainData[g].groupid == 2) { // If the group is "school dates" then change style
      style = "color: red; background-color: pink;"
    } else {
      style = "";
    }

    items.add( // Add data into the vis dataset
      {
        id: g,
        start : start,
        content: mainData[g].headline,
        group: mainData[g].groupid,
        end: end,
        type: type,
        style: style
      }
      );
  } // end of for loop

  // Process group data table
  var groupData = tabletop.sheets("Groups").all()

  var groups = new vis.DataSet();

  for (var g = 0; g < groupData.length; g++) {
    groups.add({id: g, content: groupData[g].groupname});
  }

  // Setup where the timeline will be placed
  var container = document.getElementById('visualization');
  
  // Setup the vis options
  var options = {
    groupOrder: 'groupid',  // groupOrder can be a property name or a sorting function
    align: "auto",
    stack: true,
    type : "point",
    orientation: "both",
    minHeight: "500px",
    maxHeight: "500px",
    start: "2015-07-26",
    end: "2015-09-30",
    zoomMax: 5168000000, // the zoom controls are in milliseconds. Keep these close to avoid users getting lost
    zoomMin: 908000000,
    timeAxis: {scale: 'day', step: 1}
  };

  var timeline = new vis.Timeline(container); // Setup new timeline object
  timeline.setOptions(options); // Set options
  timeline.setGroups(groups); // Set groups
  timeline.setItems(items); // Set items

} // End of timeline processing

// Function to reformat dates from the spreadsheet to something vis can work with
function dateFormat(date,type) {
  var h,m
  firstSlash = date.indexOf('/');
  lastSlash = date.lastIndexOf('/');
  year = date.slice(lastSlash + 1,lastSlash + 5);
  month = date.slice(0,firstSlash)-1; // JS months are zero indexed
  day = date.slice(firstSlash+1,lastSlash);
  
  if (type == "end") { // Make sure that events with an end date take a whole day
    h = 23;
    m = 59;
  }

  if (type == "start") { // Events start at midday (helps locate the points better)
    h = 12;
    m = 0;
  }

  var date2 = new Date(year, month, day,h,m,0,0);
//console.log(date2);  

  return date2;
}

</script>

</body>
</html>